# OpenFold3-MLX MSA Template Fix Patch
#
# This patch fixes the bug where ColabFold MSA server always tries to read
# template files even when templates are disabled, causing pandas parsing
# errors and silent fallbacks to no-MSA mode.
#
# Root Cause:
# - use_templates parameter not passed to MSA preprocessing
# - Template file reading not conditional on use_templates setting
#
# Files to modify:
# 1. openfold3/core/data/framework/data_module.py (line ~521)
# 2. openfold3/core/data/tools/colabfold_msa_server.py (lines ~701, ~712-714, ~963)

diff --git a/openfold3/core/data/framework/data_module.py b/openfold3/core/data/framework/data_module.py
index existing..fixed 100644
--- a/openfold3/core/data/framework/data_module.py
+++ b/openfold3/core/data/framework/data_module.py
@@ -518,6 +518,7 @@ class InferenceDataModule(DataModule):

         if self.use_msa_server:
             self.inference_config.query_set = preprocess_colabfold_msas(
                 inference_query_set=self.inference_config.query_set,
                 compute_settings=self.msa_computation_settings,
+                use_templates=self.use_templates,
             )

         if self.use_templates:

diff --git a/openfold3/core/data/tools/colabfold_msa_server.py b/openfold3/core/data/tools/colabfold_msa_server.py
index existing..fixed 100644
--- a/openfold3/core/data/tools/colabfold_msa_server.py
+++ b/openfold3/core/data/tools/colabfold_msa_server.py
@@ -960,8 +960,9 @@ class MsaComputationSettings(BaseModel):

 def preprocess_colabfold_msas(
     inference_query_set: InferenceQuerySet,
     compute_settings: MsaComputationSettings,
+    use_templates: bool = False,
 ) -> InferenceQuerySet:
     """Gathers sequences, runs the ColabFold MSA server queries, updates MSA paths.

@@ -1025,11 +1026,12 @@ def preprocess_colabfold_msas(
     colabfold_query_runner = ColabfoldQueryRunner(
         colabfold_mapper=colabfold_mapper,
         output_directory=output_directory,
         msa_file_format=compute_settings.msa_file_format,
         user_agent=compute_settings.server_user_agent,
         host_url=compute_settings.server_url,
+        use_templates=use_templates,
     )
     colabfold_query_runner.query_format_main()
     colabfold_query_runner.query_format_paired()

@@ -665,12 +665,14 @@ class ColabfoldQueryRunner:
     def __init__(
         self,
         colabfold_mapper: ColabFoldMapper,
         output_directory: Path,
         msa_file_format: Literal["npz", "a3m"] = "npz",
         user_agent: str = "openfold",
         host_url: str = "https://api.colabfold.com",
+        use_templates: bool = False,
     ):
         self.colabfold_mapper = colabfold_mapper
         self.output_directory = output_directory
         self.msa_file_format = msa_file_format
         self.user_agent = user_agent
         self.host_url = host_url
+        self.use_templates = use_templates
         for subdir in ["raw", "main", "paired"]:
             (self.output_directory / subdir).mkdir(parents=True, exist_ok=True)
             if subdir == "raw":
@@ -698,7 +700,7 @@ class ColabfoldQueryRunner:
         a3m_lines_main = query_colabfold_msa_server(
             self.colabfold_mapper.seqs,
             prefix=self.output_directory / "raw/main",
-            use_templates=False,
+            use_templates=self.use_templates,
             use_pairing=False,
             user_agent=self.user_agent,
             host_url=self.host_url,
@@ -709,9 +711,18 @@ class ColabfoldQueryRunner:
         template_alignments_path = self.output_directory / "template"
         template_alignments_path.mkdir(parents=True, exist_ok=True)

-        template_alignments = pd.read_csv(
-            self.output_directory / "raw/main/pdb70.m8", sep="\t", header=None
-        )
-        m_with_templates = set(template_alignments[0])
+        # Only read template alignments if templates are enabled and file exists
+        m_with_templates = set()
+        pdb70_file = self.output_directory / "raw/main/pdb70.m8"
+
+        if self.use_templates and pdb70_file.exists() and pdb70_file.stat().st_size > 0:
+            try:
+                template_alignments = pd.read_csv(pdb70_file, sep="\t", header=None)
+                if not template_alignments.empty:
+                    m_with_templates = set(template_alignments[0])
+            except (pd.errors.EmptyDataError, pd.errors.ParserError) as e:
+                # Log warning but continue without templates
+                print(f"Warning: Could not parse template file {pdb70_file}: {e}")

         for rep_id, aln in zip(
             self.colabfold_mapper.rep_ids, a3m_lines_main, strict=False