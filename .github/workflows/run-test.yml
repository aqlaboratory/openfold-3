name: Run Tests

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:

    - name: Clean up GH disk
      run: |
           sudo rm -rf $ANDROID_SDK_ROOT 
           
    - uses: actions/checkout@v4

    - name: Ensuring build paths
      run: mkdir -p resources/params

    - name: Cache Stereo Chemical Props
      id: cache-stereo_chemical_props
      uses: actions/cache@v4
      with:
        path: resources/stereo_chemical_props.txt
        key: ${{ runner.os }}-stereo_chemical_props.txt

    - name: Download Stereo Chemical Props
      if: steps.cache-stereo_chemical_props.outputs.cache-hit != 'true'
      run: |
           curl -sL -o resources/stereo_chemical_props.txt https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt

    - name: Cache Alphafold Params Model 1 PTM
      id: cache-params_model_1_ptm
      uses: actions/cache@v4
      with:
        path: resources/params/params_model_1_ptm.npz
        key: ${{ runner.os }}-params_model_1_ptm.npz
        
    - name: Download Alphafold Params 2022-12-06
      if: steps.cache-params_model_1_ptm.outputs.cache-hit != 'true'
      run: |
           curl -sL -o resources/alphafold_params_2022-12-06.tar https://storage.googleapis.com/alphafold/alphafold_params_2022-12-06.tar
           tar -C resources/params -xvf resources/alphafold_params_2022-12-06.tar params_model_1_ptm.npz
           rm resources/alphafold_params_2022-12-06.tar

    - name: Building the Docker images
    
      run: |
           docker build -f Dockerfile -t openfold-base .
           docker build -f tests/Dockerfile -t openfold-test .
            
    - name: Run unit tests
      run: docker run -v ./resources:/opt/openfold3/openfold3/resources openfold-test pytest tests
