name: Docker Image CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Cleanup  # https://github.com/actions/runner-images/issues/2840#issuecomment-2272410832
      shell: bash
      run: |
        echo "Clean up disk space before building docker image"
        df -h
        sudo rm -rf \
          "$AGENT_TOOLSDIRECTORY" \
          /opt/google/chrome \
          /opt/microsoft/msedge \
          /opt/microsoft/powershell \
          /opt/pipx \
          /usr/lib/mono \
          /usr/local/julia* \
          /usr/local/lib/android \
          /usr/local/lib/node_modules \
          /usr/local/share/chromium \
          /usr/local/share/powershell \
          /usr/share/dotnet \
          /usr/share/swift 
        df -h
    - name: Build the Docker image
      run: docker build -f Dockerfile -t openfold-docker .
    - name: Run import openfold 
      run: docker run openfold-docker python -c 'import openfold3' 
    - name: Run unit tests
      run: docker run openfold-docker pytest tests/ 